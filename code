=====================================================================================================================wslçš„å®‰è£…åŠå…³é—­=======================================================================================================================================================================
#å®‰è£…wslè‡³Dç›˜wslæ–‡ä»¶å¤¹
wsl --install --web-download --location D:\wsl 
#æŸ¥çœ‹æ‰€æœ‰å‘è¡Œç‰ˆè¯¦ç»†ä¿¡æ¯,ç®€å†™wsl -l -v
wsl --list --verbose 
#å…³é—­ç‰¹å®šå‘è¡Œç‰ˆ
wsl --terminate Ubuntu
#å…³é—­æ‰€æœ‰
wsl --shutdown

=====================================================================================================================æ–‡ä»¶å¤¹çš„å»ºç«‹åŠåŒ…çš„å®‰è£…=======================================================================================================================================================================
#åˆ›å»ºæ–‡ä»¶å¤¹
mkdir bcr
cd bcr
mkdir igblast_tool raw_data references results scripts
#å°†åŸå§‹çš„æµ‹åºæ–‡ä»¶ab1æ”¾å…¥raw_dataæ–‡ä»¶å¤¹ä¸‹
#å®‰è£…miniconda3
cd ~
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh
#è£…å®Œåæ‰§è¡Œ
source ~/.bashrc
#æˆåŠŸåè¿è¡Œä¸‹é¢ä»£ç ï¼Œçœ‹åˆ°ç‰ˆæœ¬è¯´æ˜å®‰è£…æˆåŠŸ
conda --version
#åˆ›å»ºåˆ†æç¯å¢ƒ
conda create -n immcantation python=3.9
#åˆ›å»ºå®Œæˆåæ¿€æ´»
conda activate immcantation
#å®‰è£…å¿…è¦çš„PythonåŒ…
cd ~/bcr
pip install biopython pandas seaborn matplotlib numpy python-Levenshtein

==================================================================================================================è„šæœ¬çš„å‡†å¤‡========================================================================================================================================================================
cd ~/bcr/scripts
nano 01_ab1_to_fasta.py
=====================================01_ab1_to_fasta.py======================================================================
#!/usr/bin/env python3
import os
import glob
from Bio import SeqIO

# === é…ç½® ===
INPUT_DIR = "../raw_data"
OUTPUT_FILE = "../results/01_cleaned_sequences.fasta"
MIN_LEN = 100 

def process_ab1():
    ab1_files = sorted(glob.glob(os.path.join(INPUT_DIR, "*.ab1")))
    if not ab1_files:
        print("âŒ é”™è¯¯: raw_data æ–‡ä»¶å¤¹é‡Œæ²¡æœ‰æ‰¾åˆ° .ab1 æ–‡ä»¶ï¼")
        return

    print(f"ğŸ“‚ å‘ç° {len(ab1_files)} ä¸ª .ab1 æ–‡ä»¶ï¼Œå¼€å§‹å¤„ç†...")
    
    with open(OUTPUT_FILE, "w") as out_handle:
        count = 0
        for f in ab1_files:
            file_name = os.path.basename(f)
            # å‡è®¾æ–‡ä»¶åç±»ä¼¼ "Cell01_Heavy.ab1"ï¼Œå»æ‰åç¼€ä½œä¸ºID
            seq_id = file_name.rsplit('.', 1)[0]
            
            try:
                # æ ¸å¿ƒæ­¥éª¤ï¼šabi-trim ä¼šæ ¹æ®è´¨é‡å€¼åˆ‡é™¤ä¸¤ç«¯
                record = SeqIO.read(f, "abi-trim")
                seq = str(record.seq)
                
                # è¿‡æ»¤è¿‡çŸ­åºåˆ—
                if len(seq) >= MIN_LEN:
                    # å†™å…¥fasta
                    out_handle.write(f">{seq_id}\n{seq}\n")
                    count += 1
                else:
                    print(f"âš ï¸ è·³è¿‡çŸ­åºåˆ—: {seq_id} (é•¿åº¦ {len(seq)})")
            except Exception as e:
                print(f"âŒ è¯»å–é”™è¯¯ {file_name}: {e}")

    print(f"âœ… å¤„ç†å®Œæˆï¼æœ‰æ•ˆåºåˆ—: {count}ã€‚ç»“æœå·²ä¿å­˜è‡³: {OUTPUT_FILE}")

if __name__ == "__main__":
    process_ab1()
===========================================================================================================================
Ctrl+O ä¿å­˜
Enter  ç¡®è®¤
Ctrl+X é€€å‡º
===========================================================================================================================
cd ~/bcr/scripts
nano 02_run_igblast.sh
======================================02_run_igblast.sh====================================================================
#!/bin/bash
set -e

PROJECT_DIR=~/bcr
IG_DIR=$PROJECT_DIR/igblast_tool
REF_DIR=$PROJECT_DIR/references
RES_DIR=$PROJECT_DIR/results

mkdir -p "$IG_DIR" "$REF_DIR" "$RES_DIR"

echo "===== Step 1: Download IgBlast if not exists ====="
if [ ! -f "$IG_DIR/bin/igblastn" ]; then
    cd "$IG_DIR"
    wget https://ftp.ncbi.nlm.nih.gov/blast/executables/igblast/release/1.22.0/ncbi-igblast-1.22.0-x64-linux.tar.gz
    tar -xzf ncbi-igblast-1.22.0-x64-linux.tar.gz --strip-components=1
    rm ncbi-igblast-1.22.0-x64-linux.tar.gz
else
    echo "IgBlast å·²å­˜åœ¨ï¼Œè·³è¿‡ä¸‹è½½"
fi

echo "===== Step 2: Download IMGT Germline if not exists ====="
cd "$REF_DIR"
if [ ! -f "imgt_ig_v_human.fa" ]; then

    wget https://www.imgt.org/download/V-QUEST/IMGT_V-QUEST_reference_directory/Homo_sapiens/IG/IGHV.fasta
    wget https://www.imgt.org/download/V-QUEST/IMGT_V-QUEST_reference_directory/Homo_sapiens/IG/IGKV.fasta
    wget https://www.imgt.org/download/V-QUEST/IMGT_V-QUEST_reference_directory/Homo_sapiens/IG/IGLV.fasta
    wget https://www.imgt.org/download/V-QUEST/IMGT_V-QUEST_reference_directory/Homo_sapiens/IG/IGHD.fasta
    wget https://www.imgt.org/download/V-QUEST/IMGT_V-QUEST_reference_directory/Homo_sapiens/IG/IGHJ.fasta
    wget https://www.imgt.org/download/V-QUEST/IMGT_V-QUEST_reference_directory/Homo_sapiens/IG/IGKJ.fasta
    wget https://www.imgt.org/download/V-QUEST/IMGT_V-QUEST_reference_directory/Homo_sapiens/IG/IGLJ.fasta

    cat IG*V.fasta > imgt_ig_v_human.fasta
    cat IG*D.fasta > imgt_ig_d_human.fasta
    cat IG*J.fasta > imgt_ig_j_human.fasta

    $IG_DIR/bin/edit_imgt_file.pl imgt_ig_v_human.fasta > imgt_ig_v_human.fa
    $IG_DIR/bin/edit_imgt_file.pl imgt_ig_d_human.fasta > imgt_ig_d_human.fa
    $IG_DIR/bin/edit_imgt_file.pl imgt_ig_j_human.fasta > imgt_ig_j_human.fa
fi

echo "===== Step 3: Make BLAST DB ====="
$IG_DIR/bin/makeblastdb -dbtype nucl -parse_seqids -in "$REF_DIR/imgt_ig_v_human.fa"
$IG_DIR/bin/makeblastdb -dbtype nucl -parse_seqids -in "$REF_DIR/imgt_ig_d_human.fa"
$IG_DIR/bin/makeblastdb -dbtype nucl -parse_seqids -in "$REF_DIR/imgt_ig_j_human.fa"

echo "===== Step 4: Run IgBlast ====="

IGDATA="$IG_DIR" \
$IG_DIR/bin/igblastn \
    -germline_db_V "$REF_DIR/imgt_ig_v_human.fa" \
    -germline_db_D "$REF_DIR/imgt_ig_d_human.fa" \
    -germline_db_J "$REF_DIR/imgt_ig_j_human.fa" \
    -auxiliary_data "$IG_DIR/optional_file/human_gl.aux" \
    -organism human \
    -domain_system kabat \
    -ig_seqtype Ig \
    -query "$RES_DIR/01_cleaned_sequences.fasta" \
    -outfmt 19 \
    -out "$RES_DIR/02_igblast_results.tsv"

echo "ğŸ‰ IgBlast è¿è¡Œå®Œæˆï¼"
========================================================================================================================
Ctrl+O ä¿å­˜
Enter  ç¡®è®¤
Ctrl+X é€€å‡º
=========================================================================================================================
cd ~/bcr/scripts
nano 03_analyze_clones.py
==========================================03_analyze_clones.py==========================================================
#!/usr/bin/env python3
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
import numpy as np
import os

try:
    import Levenshtein
except ImportError:
    print("âš ï¸ æç¤º: æœªå®‰è£… python-Levenshteinï¼Œå°†ä½¿ç”¨è¾ƒæ…¢çš„è·ç¦»è®¡ç®—æ–¹æ³•ã€‚")
    Levenshtein = None

# ä½ çš„æ–‡ä»¶è·¯å¾„
INPUT_FILE = "../results/02_igblast_results.tsv"  # ç¡®ä¿è·¯å¾„å¯¹
OUTPUT_DIR = "../results/analysis_output"
# å…‹éš†èšç±»é˜ˆå€¼ (0.15 = 85% ç›¸ä¼¼åº¦)
DIST_THRESHOLD = 0.15

# åˆ›å»ºè¾“å‡ºç›®å½•
os.makedirs(OUTPUT_DIR, exist_ok=True)

print("Loading data...")
# è¯»å– TSV (AIRR æ ¼å¼)
df = pd.read_csv(INPUT_FILE, sep="\t")

# ç®€å•æ¸…æ´—
# 1. è¿‡æ»¤ Productive (ä½ çš„æ•°æ®é‡Œæ˜¯ç”¨ T/F è¡¨ç¤ºï¼Œè¿˜æ˜¯ True/Falseï¼Œè¿™é‡Œåšä¸ªå…¼å®¹)
df['productive'] = df['productive'].astype(str)
df = df[df['productive'].isin(['T', 'True', 'TRUE'])]

# 2. æå– Cell ID (ç”¨äºé…å¯¹)
# å‡è®¾ Sequence ID æ ¼å¼ä¸º "A11-H.HR.900359.G01218F01.F01"
# é€»è¾‘ï¼šå–'-'å‰çš„éƒ¨åˆ†ä½œä¸º Cell ID
df['cell_id'] = df['sequence_id'].apply(lambda x: x.split('-')[0])

# 3. åŒºåˆ† Heavy / Light é“¾
def get_chain_type(v_call):
    if pd.isna(v_call): return "Unknown"
    if "IGH" in v_call: return "Heavy"
    if "IGK" in v_call or "IGL" in v_call: return "Light"
    return "Unknown"


df['chain_type'] = df['v_call'].apply(get_chain_type)

# 4. ç®€åŒ– V Gene åç§° (å»é™¤ç­‰ä½åŸºå› ï¼Œå¦‚ IGHV1-18*01 -> IGHV1-18)
df['v_family'] = df['v_call'].apply(lambda x: x.split('*')[0] if pd.notna(x) else "Unknown")
df['j_family'] = df['j_call'].apply(lambda x: x.split('*')[0] if pd.notna(x) else "Unknown")

print(f"Data Loaded. Total Productive Sequences: {len(df)}")
print(df['chain_type'].value_counts())

print("\n--- Generating Gene Usage Plots ---")

# é‡é“¾ V Gene
plt.figure(figsize=(12, 8))
heavy_v = df[df['chain_type'] == 'Heavy']['v_family'].value_counts().head(20)
if not heavy_v.empty:
    sns.barplot(x=heavy_v.values, y=heavy_v.index, palette="viridis")
    plt.title("Top 20 Heavy Chain V-Gene Usage")
    plt.xlabel("Count")
    plt.tight_layout()
    plt.savefig(f"{OUTPUT_DIR}/Heavy_V_Usage.png")

# è½»é“¾ V Gene
plt.figure(figsize=(12, 8))
light_v = df[df['chain_type'] == 'Light']['v_family'].value_counts().head(20)
if not light_v.empty:
    sns.barplot(x=light_v.values, y=light_v.index, palette="plasma")
    plt.title("Top 20 Light Chain V-Gene Usage")
    plt.xlabel("Count")
    plt.tight_layout()
    plt.savefig(f"{OUTPUT_DIR}/Light_V_Usage.png")

print("\n--- Generating SHM Analysis ---")
# v_identity ä»£è¡¨ä¸ Germline çš„ä¸€è‡´æ€§ã€‚ Mutation Rate = 100 - v_identity
df['mutation_rate'] = 100 - df['v_identity']

plt.figure(figsize=(8, 6))
sns.histplot(data=df, x='mutation_rate', hue='chain_type', kde=True, bins=30)
plt.title("Somatic Hypermutation (SHM) Distribution")
plt.xlabel("Mutation Rate (%) (100 - v_identity)")
plt.savefig(f"{OUTPUT_DIR}/SHM_Distribution.png")

# CDR3 é•¿åº¦åˆ†å¸ƒ
df['cdr3_length'] = df['cdr3_aa'].str.len()
plt.figure(figsize=(8, 6))
sns.histplot(data=df, x='cdr3_length', hue='chain_type', kde=True, element="step")
plt.title("CDR3 Amino Acid Length Distribution")
plt.savefig(f"{OUTPUT_DIR}/CDR3_Length_Distribution.png")

print("\n--- Running Clonal Clustering ---")

# ä»…å¯¹é‡é“¾è¿›è¡Œèšç±»
heavy_df = df[df['chain_type'] == 'Heavy'].copy().reset_index(drop=True)


# å®šä¹‰ç®€å•çš„æ±‰æ˜è·ç¦»å‡½æ•°
def hamming_dist(s1, s2):
    if len(s1) != len(s2): return float('inf')
    if Levenshtein:
        return Levenshtein.hamming(s1, s2) / len(s1)
    else:
        return sum(c1 != c2 for c1, c2 in zip(s1, s2)) / len(s1)


# èšç±»é€»è¾‘ï¼š
# 1. å¿…é¡»ç›¸åŒçš„ V gene (family level) å’Œ J gene (family level)
# 2. å¿…é¡»ç›¸åŒçš„ CDR3 é•¿åº¦
# 3. CDR3 æ ¸è‹·é…¸å·®å¼‚ < 15% (DIST_THRESHOLD)

# ä¸´æ—¶ç”Ÿæˆä¸€ä¸ª Group Key åŠ é€Ÿ
heavy_df['group_key'] = heavy_df['v_family'] + "_" + heavy_df['j_family'] + "_" + heavy_df['cdr3_aa'].str.len().astype(
    str)

clone_id_counter = 1
heavy_df['clone_id'] = -1

# è´ªå©ªèšç±»ç®—æ³•
for key, group in heavy_df.groupby('group_key'):
    indices = group.index.tolist()

    while indices:
        current_idx = indices.pop(0)
        # å¦‚æœå·²ç»è¢«åˆ†é…äº†ï¼ˆè™½ç„¶é€»è¾‘ä¸Šä¸ä¼šï¼Œä½†ä¸ºäº†ä¿é™©ï¼‰
        if heavy_df.at[current_idx, 'clone_id'] != -1:
            continue

        # åˆ†é…æ–° Clone ID
        current_clone_id = clone_id_counter
        heavy_df.at[current_idx, 'clone_id'] = current_clone_id
        clone_seq = heavy_df.at[current_idx, 'cdr3']  # æ³¨æ„ï¼šè¿™é‡Œç”¨æ ¸è‹·é…¸ cdr3 èšç±»æ›´å‡†ï¼Œå¦‚æœåªæœ‰ aaï¼Œæ”¹ç”¨ cdr3_aa

        # æ‰¾åŒç»„é‡Œå‰©ä¸‹çš„
        remains = []
        for other_idx in indices:
            other_seq = heavy_df.at[other_idx, 'cdr3']
            # è®¡ç®—è·ç¦»
            dist = hamming_dist(clone_seq, other_seq)
            if dist <= DIST_THRESHOLD:
                # å½’ä¸ºåŒä¸€å…‹éš†
                heavy_df.at[other_idx, 'clone_id'] = current_clone_id
            else:
                remains.append(other_idx)

        indices = remains
        clone_id_counter += 1

print(f"Total Clones Identified: {clone_id_counter - 1}")

print("\n--- Generating Clone Plots ---")

# ç»Ÿè®¡å…‹éš†å¤§å°
clone_counts = heavy_df['clone_id'].value_counts().reset_index()
clone_counts.columns = ['clone_id', 'size']

# é¥¼å›¾ (å±•ç¤ºå‰20å¤§å…‹éš† + Others)
top_n = 19
top_clones = clone_counts.head(top_n)
others_count = clone_counts.iloc[top_n:]['size'].sum() if len(clone_counts) > top_n else 0

labels = [f"Clone {cid}" for cid in top_clones['clone_id']]
sizes = list(top_clones['size'])
if others_count > 0:
    labels.append("Others")
    sizes.append(others_count)

# ç»˜åˆ¶ç”œç”œåœˆå›¾ 
plt.figure(figsize=(10, 10))
plt.pie(
    sizes,
    labels=labels,
    autopct='%1.1f%%',
    startangle=140,
    pctdistance=0.82,     # ç™¾åˆ†æ¯”æ›´é å†…ï¼Œé¿å…é‡å 
    textprops={'fontsize': 12}
)

# ç”»å†…åœˆï¼ˆç”œç”œåœˆæ´ï¼‰
centre_circle = plt.Circle(
    (0, 0),
    0.70,                  # æ´å¤§å°
    fc='white',
    edgecolor='black',
    linewidth=1.2          # è®©æ´çš„è¾¹æ›´æ¸…æ™°
)
fig = plt.gcf()
fig.gca().add_artist(centre_circle)

# å†™å…¥ä¸­å¿ƒæ–‡å­—ï¼ˆ*ä»…æ€»ç»†èƒæ•°*ï¼‰
total_cells = heavy_df.shape[0]

plt.text(
    0, 0,
    f"N = {total_cells}",   # ä¸­å¿ƒæ˜¾ç¤ºæ€»ç»†èƒæ•°
    ha='center',
    va='center',
    fontsize=18,
    fontweight='bold'
)

# æ ‡é¢˜ & ä¿å­˜
plt.title(f"Clonal Distribution (Top {top_n})", fontsize=18, pad=20)
plt.tight_layout()
plt.savefig(f"{OUTPUT_DIR}/Clone_Pie_Chart.png", dpi=300)
plt.close()

# ä¿å­˜é…å¯¹ç»“æœ
# æŠŠè½»é“¾ä¿¡æ¯åˆå›æ¥
light_df = df[df['chain_type'] == 'Light'][['cell_id', 'v_call', 'cdr3_aa', 'sequence_id']].rename(columns={
    'v_call': 'light_v_call', 'cdr3_aa': 'light_cdr3_aa', 'sequence_id': 'light_sequence_id'
})

final_df = pd.merge(heavy_df, light_df, on='cell_id', how='left')
final_df = pd.merge(final_df, clone_counts, on='clone_id', how='left')

# è¾“å‡ºæœ€ç»ˆè¡¨æ ¼
final_csv = f"{OUTPUT_DIR}/Final_Clonotypes_Analysis.csv"
final_df.to_csv(final_csv, index=False)
print(f"âœ… Analysis Complete! Results saved to: {final_csv}")
===========================================================================================================================
Ctrl+O ä¿å­˜
Enter  ç¡®è®¤
Ctrl+X é€€å‡º

===========================================================================================================================æ‰§è¡Œè„šæœ¬===============================================================================================================================================================
python3 01_ab1_to_fasta.py
bash 02_run_igblast.sh
python3 03_analyze_clones.py

==================================================================================================================================================================================================================================================================================================
#resultsæ–‡ä»¶å¤¹ä¸‹çš„ç»“æœè¯·åŠæ—¶è½¬ç§»ï¼Œé¿å…æ–°è¿è¡Œäº§ç”Ÿçš„ç»“æœæ··æ·†
#åç»­åªéœ€æŠŠåŸå§‹æµ‹åºæ–‡ä»¶æ”¾å…¥raw_dataæ–‡ä»¶å¤¹ä¸‹ï¼Œä¾æ¬¡æ‰§è¡Œä¸‰ä¸ªè„šæœ¬å³å¯




